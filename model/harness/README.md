RC_Car_Demo/model/harness
=========================

The RC Car Demo builds for an embedded target and thus a specialized configuration is required to use any artifacts produced.
This makes examination or comparison of the results of controller design difficult.
To work around this, we have developed a simulation harness in Ada that will simulate the QGen-generated steering controller and the original Ada steering controller using the QGen-generated NXT motor model.

Building the Ada simulation harness requires GNAT.
The build was tested using GNAT Pro 22.2.

***Note:** Prior to building, you need to generate code using QGen; see the `README.md` in `RC_Car_Demo/model` for details.*


# Building #

From a system command prompt, navigate to the `harness` directory and run:

    gprbuild harness.gpr

`gprbuild` will report on its progress compiling, binding and linking the project.
Some style messages may be displayed; these arise from the QGen-generated code and can be ignored safely.

# Running #

From a system command prompt, run:

    host-obj/harness --mode B2B

This will execute the simulation, running both the QGen-generated and the original Ada steering controllers in a closed-loop with the NXT motor.
Note that, in this mode, *only* the QGen-generated controller's outputs are affecting the NXT motor; this is why the performance of the original Ada steering controller appears so poor.

You can experiment with the other modes of simulation, which are reported using:

    host-obj/harness --help

# Design #

The simulation harness is designed to reuse the `Ada_Steering_Controller` from the original RC Car demo without modification.

The `Simulator` simply `with`s the `Ada_Steering_Controller`, which we ensure in the project file is available through the listing of its containing source directory.

While this works, it poses a problem: the `Simulator`, the `Ada_Steering_Controller`, and the generated code all depend on a variety of definitions, directly or indirectly, that are provided by `NXT.Motors`, `Vehicle`, and `Steering_Control`.
All of these eventually depend on modules provided by project that require explicitly the availability of the ARM-Elf toolchain in their project files.
Since the purpose of creating the simulation harness was to avoid this toolchain and enable simulation on the host, we have to work around this problem.

We do this by introducing, in the `mocks` directory, mock ups of these modules: purpose-built modules of the same name that define *only* the functionality required by the `Simulator`, the `Ada_Steering_Controller`, and the generated code.
This works well, but since the directory containing the `Ada_Steering_Controller` also contains implementations of `Vehicle` and `Steering_Control`, we have to excluded these files from consideration in the project file.

The result of these excludes and the mock ups is that we can compile and build the simulation harness using a host-native toolchain while referencing the original `Ada_Steering_Controller`.
We can thus execute the `Ada_Steering_Controller` in simulation with our NXT motor and assess its performance - gaining confidence that it will work as expected when deployed on the target.

We can likewise execute the code generated by QGen in simulation with our NXT motor and confirm that it performs as it did in simulation in MATLAB Simulink.
